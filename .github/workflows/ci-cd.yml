name: CI/CD Pipeline

on:
  push:
    branches:
      - master  # master 브랜치로 push 시 워크플로우 실행

jobs:
  deploy:
    runs-on: ubuntu-latest  # GitHub Actions에서 사용할 VM 환경

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3  # 소스코드 가져오기

    - name: Set up Ansible
      run: |
        sudo apt-get update
        sudo apt-get install -y ansible

    - name: Add SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.ANSIBLE_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.MASTER_NODE_IP }} >> ~/.ssh/known_hosts

    - name: Run Ansible Playbook
      env:
        MASTER_NODE_IP: ${{ secrets.MASTER_NODE_IP }}  # 마스터 노드 IP
        SSH_USER: ${{ secrets.SSH_USER }}  # SSH 사용자
      run: |
        ansible-playbook -i "${{ secrets.MASTER_NODE_IP }}," -u ${{ secrets.SSH_USER }} playbook.yml

    - name: Docker Login & Push
      env:
        HARBOR_USER: ${{ secrets.HARBOR_USER }}
        HARBOR_PASS: ${{ secrets.HARBOR_PASS }}
        HARBOR_URL: 211.183.3.198
        HARBOR_REPO: myproject/keduitlab
      run: |
        echo $HARBOR_PASS | docker login $HARBOR_URL -u $HARBOR_USER --password-stdin
        docker build -t $HARBOR_URL/$HARBOR_REPO:white .
        docker push $HARBOR_URL/$HARBOR_REPO:white
